<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Internal IT Wiki</title>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@acab/reset.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@latest/font/lucide.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" />
  <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">
</head>
<body class="bg-slate-950 text-gray-100 min-h-screen">
  {% set icon_map = {
    'company': 'lucide-building',
    'dc': 'lucide-server',
    'section': 'lucide-folder',
    'document': 'lucide-file-text',
    'service': 'lucide-layers',
    'server': 'lucide-cpu',
    'network': 'lucide-network',
  } %}
  {% macro icon_for(t) %}{{ icon_map.get(t, 'lucide-circle-dot') }}{% endmacro %}
  <div class="flex h-screen overflow-hidden">
    <aside class="w-72 bg-slate-900 border-r border-slate-800 flex-shrink-0 overflow-y-auto">
      <div class="px-4 py-4 flex items-center gap-2 border-b border-slate-800">
        <i class="lucide lucide-orbit text-emerald-400"></i>
        <div>
          <div class="font-semibold">Internal IT Wiki</div>
          <div class="text-xs text-gray-400">Dark / VMware style</div>
        </div>
      </div>
      <div class="px-4 py-3 border-b border-slate-800">
        <div class="text-xs text-gray-400 mb-2">Дерево</div>
        <div id="tree" class="space-y-2">
          {% macro render_tree(nodes, level=0) %}
            {% for node in nodes %}
              <div class="ml-{{ level * 8 }}">
                <a href="/view/{{ node.path }}" class="flex items-center gap-2 py-1 px-2 rounded hover:bg-slate-800 {% if current_path == node.path %}bg-slate-800{% endif %}">
                  <i class="lucide text-emerald-400 text-sm {{ icon_for(node.type) }}"></i>
                  <span class="text-sm">{{ node.title }}</span>
                </a>
                {% if node.children %}
                  {{ render_tree(node.children, level + 1) }}
                {% endif %}
              </div>
            {% endfor %}
          {% endmacro %}
          {{ render_tree(tree) }}
        </div>
      </div>
      <div class="px-4 py-4 text-xs text-gray-500">
        /opt/wiki/content
      </div>
    </aside>
    <div class="flex-1 flex flex-col">
      <header class="border-b border-slate-800 bg-slate-900/80 backdrop-blur px-6 py-3 flex items-center gap-4">
        <form action="/search" method="get" class="flex-1 flex items-center gap-2">
          <div class="relative flex-1">
            <i class="lucide lucide-search absolute left-3 top-2.5 text-gray-500"></i>
            <input type="text" name="q" value="{{ query if query is defined else '' }}" placeholder="Поиск по заголовкам и контенту" class="w-full bg-slate-800 border border-slate-700 rounded pl-9 pr-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          </div>
        </form>
        <button id="open-create" class="flex items-center gap-2 bg-emerald-500 hover:bg-emerald-400 text-slate-900 px-3 py-2 rounded text-sm font-semibold">
          <i class="lucide lucide-plus"></i> Создать
        </button>
      </header>
      <main class="flex-1 overflow-y-auto p-6">
        {% block content %}{% endblock %}
      </main>
    </div>
  </div>

  <div id="create-modal" class="fixed inset-0 bg-black/60 backdrop-blur hidden items-center justify-center z-20">
    <div class="bg-slate-900 border border-slate-700 rounded-lg w-full max-w-lg shadow-xl">
      <div class="flex justify-between items-center px-4 py-3 border-b border-slate-800">
        <div>
          <div class="font-semibold">Создать узел</div>
          <div class="text-xs text-gray-400">Система сама подберёт родителя по контексту</div>
        </div>
        <button id="close-create" class="text-gray-400 hover:text-white">
          <i class="lucide lucide-x"></i>
        </button>
      </div>
      <form id="create-form" class="p-4 space-y-3">
        <div>
          <label class="text-sm text-gray-300">Заголовок</label>
          <input required name="title" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 mt-1" placeholder="Например: Бэкенд" />
        </div>
        <div>
          <label class="text-sm text-gray-300">Тип</label>
          <select name="type" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 mt-1">
            <option value="company">Company</option>
            <option value="dc">DC</option>
            <option value="section">Section</option>
            <option value="document">Document</option>
            <option value="service">Service</option>
            <option value="server">Server</option>
            <option value="network">Network</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-gray-300">Родитель</label>
          <select name="parent" id="parent-picker" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 mt-1">
            <option value="">/ (корень)</option>
            {% macro render_options(nodes, prefix='') %}
              {% for node in nodes %}
                <option value="{{ node.path }}" {% if current_path == node.path %}selected{% endif %}>{{ prefix }}{{ node.title }} ({{ node.type }})</option>
                {% if node.children %}
                  {{ render_options(node.children, prefix + '› ') }}
                {% endif %}
              {% endfor %}
            {% endmacro %}
            {{ render_options(tree) }}
          </select>
          <p class="text-xs text-gray-500 mt-1">Если выбрана Document/Service, родителем станет его родитель.</p>
        </div>
        <div class="flex justify-end gap-2 pt-2 border-t border-slate-800">
          <button type="button" id="cancel-create" class="px-3 py-2 rounded bg-slate-800 text-sm">Отмена</button>
          <button type="submit" class="px-4 py-2 rounded bg-emerald-500 text-slate-900 font-semibold">Создать</button>
        </div>
      </form>
    </div>
  </div>

  <div id="toast" class="fixed bottom-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow hidden"></div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({ startOnLoad: true, theme: 'dark' });
    const modal = document.getElementById('create-modal');
    const openBtn = document.getElementById('open-create');
    const closeBtn = document.getElementById('close-create');
    const cancelBtn = document.getElementById('cancel-create');
    const form = document.getElementById('create-form');
    const toast = document.getElementById('toast');

    function showModal() { modal.classList.remove('hidden'); modal.classList.add('flex'); }
    function hideModal() { modal.classList.add('hidden'); modal.classList.remove('flex'); }
    function showError(msg) {
      toast.textContent = msg;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 4000);
    }

    if (openBtn) openBtn.addEventListener('click', showModal);
    [closeBtn, cancelBtn].forEach(btn => btn && btn.addEventListener('click', hideModal));

    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(form).entries());
        const res = await fetch('/api/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!res.ok) {
          const payload = await res.json().catch(() => ({}));
          showError(payload.error || 'Не удалось создать узел');
          return;
        }
        const payload = await res.json();
        window.location.href = payload.view_url;
      });
    }

    function hydrateMermaid() {
      const blocks = document.querySelectorAll('code.language-mermaid');
      blocks.forEach((block) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'mermaid';
        wrapper.textContent = block.textContent;
        const pre = block.closest('pre');
        if (pre) {
          pre.replaceWith(wrapper);
        }
      });
      if (blocks.length) {
        try { mermaid.init(); } catch (e) { console.warn('Mermaid render error', e); }
      }
    }
    window.addEventListener('load', hydrateMermaid);
  </script>
  {% block scripts %}{% endblock %}
</body>
</html>
